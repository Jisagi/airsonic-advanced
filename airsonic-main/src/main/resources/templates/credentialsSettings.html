<!DOCTYPE html>

<html><head>

  <th:block th:replace="head" />
  <th:block th:replace="jquery" />
    <script type="text/javascript" th:src="@{/script/utils.js}"></script>

    <script type="text/javascript" th:inline="javascript">
      function createNewCredsFnc(event) {
        $("#createNewCreds").dialog({resizable: true, width: 600, title: "[(#{credentialsettings.addcredentials})]", position: { my: "top", at: "top", of: window },
            buttons: {
                "[(#{common.cancel})]": function() {
                    $(this).dialog("close");
                },
                "[(#{common.create})]": function() {
                    $(document.getElementById("newCreds")).submit();
                }
            }});

        event.preventDefault();  
      }

      function selectButtonCheckboxAndSubmit(clickedButton, event) {
        clickedButton.childNodes[1].checked=true;
      }

      var appsSettings = [[${appsMap}]];
      var decodableEncoders = [(${decodableEncodersJson})];
      var defaultEncoderDecodableOnly = "[(${preferredEncoderDecodableOnly})]";
      var nonDecodableEncoders = [(${nonDecodableEncodersJson})];
      var defaultEncoderNonDecodableAllowed = "[(${preferredEncoderNonDecodableAllowed})]";
      var encoderAliases = [(${encoderAliasesJson})];

      function bindNewCredsForm() {

          var app = $('#app').val();
          // enable or disable user name field
          if (appsSettings[app]?.usernameRequired) {
            $('#username').val('').attr('value', '');
            $('#username').prop('disabled', false);
          } else {
            $('#username').prop('disabled', true);
            $('#username').val('Not required').attr('value', 'Not required');
          }

          var el = $('#encoder');
          el.empty();

          var defaultOptionIncluded = false;
          // add decodable options
          el.append($("<option value='notselectable' disabled='disabled'>Decodable</option>"));
          $.each(decodableEncoders, function(k, v) {
            if (v == defaultEncoderNonDecodableAllowed) {
              defaultOptionIncluded = true;
            }
            el.append($("<option></option>").attr("value", v).text(encoderAliases[v] != null ? encoderAliases[v] : v));
          });

          // enable or disable nondecodable options
          if (appsSettings[app]?.nonDecodableEncodersAllowed) {
            el.append($("<option value='notselectable' disabled='disabled'>Non-Decodable</option>"));
            $.each(nonDecodableEncoders, function(k, v) {
              if (v == defaultEncoderNonDecodableAllowed) {
                defaultOptionIncluded = true;
              }
              el.append($("<option></option>").attr("value", v).text(encoderAliases[v] != null ? encoderAliases[v] : v));
            });
          }

          el.val(defaultOptionIncluded ? defaultEncoderNonDecodableAllowed : defaultEncoderDecodableOnly);
      }

      function bindComponentHandling() {
        bindNewCredsForm();

        // need to submit all fields, so remove the disabled restriction
        $('#newCreds').submit(function(e) {
          $('#username').removeAttr('disabled');
        });

        // createNewCreds handling
        $('#app').change(function(ev) {
          bindNewCredsForm();
        });

        // grey out last delete button for airsonic creds
        if ($('.airsonic-cred').length == 1) {
          $('.airsonic-cred .delete-cred').prop('disabled', true);
        }
        
        // blur out sensitive data
        $('.sensitive').hover(function() {
          $(this).removeClass('blur');
        }).mouseout(function() {
          $(this).addClass('blur');
        });

        let open_CreateCredsDialog = [[${open_CreateCredsDialog}]];
        if(open_CreateCredsDialog) {
          // open create dialog automatically if ordained by server
          $('#createcredsbutton').click();
        }
      }

      $(document).ready(bindComponentHandling);
    </script>
</head>

<body class="mainframe bgcolor1">
<script type="text/javascript" th:src="@{/script/wz_tooltip.js}"></script>
<script type="text/javascript" th:src="@{/script/tip_balloon.js}"></script>

<th:block th:replace="settingsHeader::header(cat='credentials',toast=${settings_toast},restricted=${!adminRole})" />

<h2>Credentials Management</h2>
<div>
<h3>Credentials</h3>
<form method="put" action="credentialsSettings.view">
  <input
          type="hidden"
          th:name="${_csrf.parameterName}"
          th:value="${_csrf.token}" />

  <table id="credentialsTable">
  <tr>
    <th style="padding:0 0.5em 0 0.5em;border-style:double">ID</th>
    <th style="padding:0 0.5em 0 0.5em;border-style:double" th:text="#{credentialsettings.app}"></th>
    <th style="padding:0 0.5em 0 0.5em;border-style:double" th:text="#{credentialsettings.user}"></th>
    <th style="padding:0 0.5em 0 0.5em;border-style:double" th:text="#{credentialsettings.comments}"></th>
    <th style="padding:0 0.5em 0 0.5em;border-style:double" th:text="#{credentialsettings.created}"></th>
    <th style="padding:0 0.5em 0 0.5em;border-style:double" th:text="#{credentialsettings.updated}"></th>
    <th style="padding:0 0.5em 0 0.5em;border-style:double" th:text="#{credentialsettings.encoder}"></th>
    <th style="padding:0 0.5em 0 0.5em;border-style:double"><span th:text="#{credentialsettings.expires}"></span><th:block th:replace="helpToolTip(topic=credentialsdates)" /></th>
    <th style="padding:0 0.5em 0 0.5em;border-style:double" th:text="#{common.delete}"></th>
  </tr>
  <tr>
    <td style="text-align:center;border-style:dotted" colspan=9>Airsonic Credentials <th:block th:replace="helpToolTip(topic=credentialsairsonic)" /></td>
  </tr>
  <th:block th:each="cred, loopStatus:${command.credentials}">
    <tr th:if="${#strings.equalsIgnoreCase(cred.app,'AIRSONIC')}" class="airsonic-cred">
      <td style="padding:0 0.5em 0 0.5em" th:text="${loopStatus.index}"></td>
      <td style="padding:0 0.5em 0 0.5em" th:text="${cred.app.name}"></td>
      <td style="padding:0 0.5em 0 0.5em" th:text="${cred.username}"></td>
      <td style="padding:0 0.5em 0 0.5em" th:text="${cred.comment}"></td>
      <td style="padding:0 0.5em 0 0.5em" th:text="${#temporals.format(cred.created, 'SHORT')}"></td>
      <td style="padding:0 0.5em 0 0.5em" th:text="${#temporals.format(cred.updated,'SHORT')}"></td>
      <td style="padding:0 0.5em 0 0.5em">
        <select th:name="|credentials[${loopStatus.index}].encoder|" th:value="${command.credentials[loopStatus.index].encoder}" style="width:9em">
          <th:block th:if="${ cred.displayComments.contains( 'decodablecred' ) }">
              <option th:if="${!decodableEncoders.contains(cred.encoder) && !nonDecodableEncoders.contains(cred.encoder)}"
                      selected="selected" th:value="${cred.encoder}" th:text="${encoderAliases[cred.encoder] != null ? encoderAliases[cred.encoder] : cred.encoder}"></option>
              <option value="notselectable" disabled="true">Decodable</option>
            <th:block th:each="migratableType:${decodableEncoders}"
                th:with="displayLabelValue=${encoderAliases[migratableType] != null ? encoderAliases[migratableType] : migratableType}">
                <option th:if="${migratableType != cred.encoder}"
                        th:value="${migratableType}"
                      th:text="${displayLabelValue}"></option>
                <option th:if="${migratableType == cred.encoder}"
                  selected="selected" th:value="${migratableType}" th:text="${displayLabelValue}"></option>
            </th:block>
            <option value="notselectable" th:text="Non-decodable" disabled="true"></option>
            <th:block th:each="migratableType:${nonDecodableEncoders}"
            th:with="displayLabelValue=${encoderAliases[migratableType] != null ? encoderAliases[migratableType] : migratableType}">
                <option th:if="${migratableType != cred.encoder}"
                        th:value="${migratableType}" th:text="${displayLabelValue}"></option>
                <option th:if="${migratableType == cred.encoder}"
                        selected="selected" th:value="${migratableType}" th:text="${displayLabelValue}"></option>
            </th:block>
          </th:block>
            <option th:if="${ !cred.displayComments.contains( 'decodablecred' ) }"
                    selected="selected"
                    th:value="${cred.encoder}"
                    th:text="${encoderAliases[cred.encoder] != null ? encoderAliases[cred.encoder] : cred.encoder}"></option>
        </select>
      </td>
      <td><input type="datetime-local" th:name="|credentials[${loopStatus.index}].expiration|"
                 th:value="${command.credentials[loopStatus.index].expiration}" /></td>
      <td style="text-align:center;">
        <input type="checkbox" th:name="|credentials[${loopStatus.index}].markedForDeletion|"
               th:checked="${command.credentials[__${loopStatus.index}__].markedForDeletion}" class="delete-cred"/>
      </td>
      <td class="warning">
        <input type="hidden" th:name="|credentials[${loopStatus.index}].hash|"
               th:value="${command.credentials[__${loopStatus.index}__].hash}" />
        <div class="warning" th:each="err: ${#fields.errors('command.credentials[__${loopStatus.index}__].hash')}" style="width:15em"
             th:text="${err}"></div>
      </td>
    </tr>
  </th:block>
  <tr th:if="${ldapAuthEnabledForUser}">
    <td class="warning" style="text-align:center" colspan=9><i th:text="#{credentialsettings.ldapauthenabledforuser}"></i></td>
  </tr>
  <tr><td> </td></tr>

  <tr>
    <td style="text-align:center;border-style:dotted" colspan=9>Third-party Credentials <th:block th:replace="helpToolTip(topic=credentialsthirdparty)" /></td>
  </tr>
  <th:block th:each="cred,loopStatus:${command.credentials}">
    <tr th:if="${!#strings.equalsIgnoreCase(cred.app,'AIRSONIC')}">
      <td style="padding:0 0.5em 0 0.5em" th:text="${loopStatus.index}"></td>
      <td style="padding:0 0.5em 0 0.5em" th:text="${cred.app.name}"></td>
      <td style="padding:0 0.5em 0 0.5em" th:text="${cred.username}"></td>
      <td style="padding:0 0.5em 0 0.5em" th:text="${cred.comment}"></td>
      <td style="padding:0 0.5em 0 0.5em" th:text="${#temporals.format(cred.created, 'SHORT')}"></td>
      <td style="padding:0 0.5em 0 0.5em" th:text="${#temporals.format(cred.updated, 'SHORT')}"></td>
      <td style="padding:0 0.5em 0 0.5em">
        <select th:name="|credentials[${loopStatus.index}].encoder|" style="width:9em">
            <option th:if="${!decodableEncoders.contains(cred.encoder)}" selected="selected" th:value="${cred.encoder}"
                    th:text="${encoderAliases[cred.encoder] != null ? encoderAliases[cred.encoder] : cred.encoder}"></option>
          <option value="notselectable" label="Decodable" disabled="true"></option>
          <th:block th:each="migratableType:${decodableEncoders}"
            th:with="displayLabelValue=${encoderAliases[migratableType] != null ? encoderAliases[migratableType] : migratableType}">
              <option th:if="${migratableType != cred.encoder}"
                      th:value="${migratableType}" th:text="${displayLabelValue}"></option>
              <option th:if="${migratableType == cred.encoder}"
                      selected="selected" th:value="${migratableType}" th:text="${displayLabelValue}"></option>
          </th:block>
        </select>
      </td>
      <td><input type="datetime-local" th:name="|credentials[${loopStatus.index}].expiration|" th:value="${cred.expiration}" /></td>
      <td style="text-align:center;">
        <input type="checkbox" th:name="|credentials[${loopStatus.index}].markedForDeletion|"
               th:checked="${cred.markedForDeletion}" class="delete-cred" />
      </td>
      <td class="warning">
        <input type="hidden" th:name="|credentials[${loopStatus.index}].hash|" th:value="${cred.hash}" />
        <form:errors class="warning" path="credentials[${loopStatus.index}].hash" cssStyle="width:15em"/>
      </td>
    </tr>
  </th:block>
</table>
<p style="padding-top:1em" th:text="#{credentialsettings.immutable}"></p>
<p style="padding-top:1em;padding-bottom:1em">
    <input type="submit" th:value="#{common.save}" style="margin-right:0.3em"/>
    <input type="button" id="createcredsbutton" th:value="#{credentialsettings.addcredentials}" onclick="createNewCredsFnc(event)"/>
    <input type="reset" th:value="#{common.cancel}" />
</p>
</form>
</div>

<div id="createNewCreds" style="display:none">
  <form method="post" action="credentialsSettings.view" id="newCreds">
    <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />

    <table style="white-space:nowrap" class="indent">
      <tr>
        <td th:text="#{credentialsettings.app}"></td>
        <td>
          <select id="app" name="app" th:value="${newCreds.app}" style="width:15em">
            <option th:each="app:${apps}" th:value="${app}" th:text="${app.name}" ></option>
          </select>
        </td>
        <td class="warning"><form:errors path="app" cssStyle="width:15em"/></td>
      </tr>

      <tr>
        <td th:text="#{login.username}"></td>
        <td><input id="username" name="username" th:value="${newCreds.username}" size="20"/></td>
        <td class="warning"><form:errors path="username" cssStyle="width:15em"/></td>
      </tr>

      <tr>
        <td th:text="#{credentialsettings.encoder}"></td>
        <td>
          <select name="encoder" style="width:15em">
            <option th:value="${preferredEncoderNonDecodableAllowed}">Non-decodable</option>
            <option th:value="${preferredEncoderDecodableOnly}">Decodable</option>
          </select>
          <td class="warning"><form:errors path="encoder" cssStyle="width:15em"/></td>
        </td>
      </tr>

      <tr>
        <td th:text="#{usersettings.newpassword}"></td>
        <td><input type="password" name="credential" th:value="${newCreds.credential}" size="20"/></td>
        <td class="warning"><form:errors path="credential" cssStyle="width:15em"/></td>
      </tr>

      <tr>
        <td th:text="#{usersettings.confirmpassword}"></td>
        <td><input type="password" name="confirmCredential" th:value="${newCreds.confirmCredential}" size="20"/></td>
       <td class="warning"><form:errors path="confirmCredential" cssStyle="width:15em"/></td>
      </tr>

      <tr>
        <td th:text="#{credentialsettings.expires}"></td>
        <td>
          <input type="datetime-local" name="expiration" th:value="${newCreds.expiration}" />
          <th:block th:replace="helpToolTip(topic=credentialsdates)" />
        </td>
      </tr>
    </table>
    <form:errors class="warning" cssStyle="width:15em"/>
  </form>
</div>

<th:block th:if="${adminRole}">
<div>
  <h3 th:text="#{credentialsettings.admincontrols}"></h3>
  <form method="post" th:action="@{/credentialsSettings/admin}">
    <input
            type="hidden"
            th:name="${_csrf.parameterName}"
            th:value="${_csrf.token}" />


    <table style="white-space:nowrap" class="indent">
      <tr><th colspan=4 style="text-align:left" th:text="#{credentialsettings.systemchecks}"></th></tr>
      <th:block th:if="${adminControls.legacyCredsPresent}">
      <tr>
        <td><span th:text="#{credentialsettings.legacycredspresent}"></span><th:block th:replace="helpToolTip(topic=credentialslegacypasswords)" /></td>
        <td>
          <button onclick="selectButtonCheckboxAndSubmit(this, event)">
            <input type="checkbox" name="migrateLegacyCredsToNonLegacyDefault" th:value="${adminControls.migrateLegacyCredsToNonLegacyDefault}" style="display:none" />
            <label th:text="#{credentialsettings.adminmigratelegacytononlegacydefault}"></label>
          </button>
        </td>
        <td>
          <button onclick="selectButtonCheckboxAndSubmit(this, event)">
            <input type="checkbox" name="migrateLegacyCredsToNonLegacyDecodableOnly" th:value="${adminControls.migrateLegacyCredsToNonLegacyDecodableOnly}" style="display:none" />
            <span th:text='#{credentialsettings.adminmigratelegacytononlegacydecodableonly}'></span>
          </button>
        </td>
      </tr>
      </th:block>
      <tr th:if="${adminControls.openCredsPresent}">
        <td colspan=4 class="warning" th:text="#{credentialsettings.opencredspresent}"></td>
      </tr>
      <tr th:if="${adminControls.defaultAdminCredsPresent}">
        <td colspan=4 class="warning"  th:text="#{credentialsettings.defaultadmincredspresent}"></td>
      </tr>
    </table>

    <table style="white-space:nowrap" class="indent">
      <tr><th style="text-align:left" th:text="#{credentialsettings.encoders}"></th></tr>
      <tr>
        <td th:text="#{credentialsettings.nondecodableencoder}"></td>
        <td>
          <select name="nonDecodableEncoder" style="width:12em">
            <th:block th:each="migratableType:${nonDecodableEncoders}"
              th:with="displayLabelValue=${encoderAliases[migratableType] != null ? encoderAliases[migratableType] : migratableType}">
              <option th:if="${migratableType != nonDecodableEncoder}"
                      th:value="${migratableType}" th:text="${displayLabelValue}"></option>
              <option th:if="${migratableType == nonDecodableEncoder}"
                      selected="selected" th:value="${migratableType}" th:text="${displayLabelValue}"></option>
            </th:block>
          </select>
        </td>
        <td>
          <button onclick="selectButtonCheckboxAndSubmit(this, event)">
            <input type="checkbox" name="nonDecodableEncoderChanged" th:value="${adminControls.nonDecodableEncoderChanged}" style="display:none" />
            <label th:text="#{common.save}"></label>
          </button>
        </td>
        <td class="warning">
          <form:errors path="nonDecodableEncoder"/>
        </td>
      </tr>
      <tr>
        <td th:text="#{credentialsettings.decodableencoder}"></td>
        <td>
          <select name="decodableEncoder" th:value="${adminControls.decodableEncoder}" style="width:12em">
            <th:block th:each="migratableType:${decodableEncoders}"
              th:with="displayLabelValue=${encoderAliases[migratableType] != null ? encoderAliases[migratableType] : migratableType}">
                <option th:if="${migratableType != decodableEncoder}"
                        th:value="${migratableType}" th:text="${displayLabelValue}"></option>
                <option th:if="${migratableType == decodableEncoder}"
                        selected="selected" th:value="${migratableType}" th:text="${displayLabelValue}"></option>
            </th:block>
          </select>
        </td>
        <td>
          <button onclick="selectButtonCheckboxAndSubmit(this, event)">
            <input type="checkbox" name="decodableEncoderChanged" th:checked="${adminControls.decodableEncoderChanged}" style="display:none" />
            <label th:text="#{common.save}"></label>
          </button>
        </td>
        <td class="warning">
          <form:errors path="decodableEncoder"/>
        </td>
      </tr>
      <tr>
        <td><label for="preferNonDecodableCheckbox" th:text="#{credentialsettings.prefernondecodablepasswords}"></label></td>
        <td style="text-align:center;">
          <input type="checkbox" id="preferNonDecodableCheckbox" name="preferNonDecodable" th:checked="${adminControls.preferNonDecodable}" />
        </td>
        <td>
          <button onclick="selectButtonCheckboxAndSubmit(this, event)">
            <input type="checkbox" name="nonDecodablePreferenceChanged" th:checked="${adminControls.nonDecodablePreferenceChanged}" style="display:none" />
            <label th:text="#{common.save}"></label>
          </button>
        </td>
      </tr>
      
      <tr><td>&nbsp;</td></tr>

      <tr><th style="text-align:left">Keys</th></tr>
      <tr><td colspan=3 th:text="#{credentialsettings.keepkeyssafe}"></td></tr>
      <tr>
        <td>JWT Key</td>
        <td>
          <input name="jwtKey" th:value="${adminControls.jwtKey}" style="width:15em" class="sensitive blur"/>
          <th:block th:replace="helpToolTip(topic=credentialsjwtkey)" />
        </td>
        <td>
          <button onclick="selectButtonCheckboxAndSubmit(this, event)">
            <input type="checkbox" name="jwtKeyChanged" th:checked="${adminControls.jwtKeyChanged}" style="display:none" />
            <label th:text="#{common.save}"></label>
          </button>
        </td>
      </tr>
      <tr>
        <td>Encryption Key Password</td>
        <td>
          <input name="encryptionKey" th:value="${adminControls.encryptionKey}" style="width:15em" class="sensitive blur"/>
          <th:block th:replace="helpToolTip(topic=credentialsencryptionkey)" />
        </td>
        <td>
          <button onclick="selectButtonCheckboxAndSubmit(this, event)">
            <input type="checkbox" name="encryptionKeyChanged" th:checked="${adminControls.encryptionKeyChanged}" style="display:none" />
            <label th:text="#{common.save}"></label>
          </button>
        </td>
      </tr>
      <tr>
        <td>Encryption Key Salt</td>
        <td colspan=2 style="font-size:90%;" class="sensitive blur" th:text="${adminControls.encryptionKeySalt}"></td>
      </tr>
    </table>

    <form:errors class="warning" cssStyle="width:15em"/>
  </form>
</div>
</th:block>

</body></html>
